<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QR Backup Printer</title>
    <style>
      /* TODO: Try this on a laptop, find a way to remove this restriction */
      @media screen and (orientation: landscape) {
        body * {
          display: none;
        }
        body::after {
          content: "Please put your device in portrait mode to continue.";
        }
      }

      body {
        font-size: 125%;
      }

      button, select {
        font-size: 80%;
      }

      #statusMessage {
        font-weight: bold;
        font-size: 150%;
      }

      .stage {
        display: none;
      }

      body[stage="detect"] .stage-detect,
      body[stage="scan"] .stage-scan,
      body[stage="backup"] .stage-backup {
        display: block;
      }

      #video {
        width: 80%;
        margin: auto;
      }

      #backupButton {
        display: none;
      }

      #qrText {
        overflow: hidden;
      }

      #qrBackup canvas {
        width: 100%;
      }

      .margin-below {
        margin-bottom: 1em;
      }

      .center-contents {
        width: 100%;
        text-align: center;
      }
    </style>
    <style type="text/css" media="print">
      .no-print {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="statusMessage" class="margin-below">Loading...</div>

    <div class="stage stage-scan no-print">
      <div class="center-contents">
        <label for="camList">Preferred camera:</label>
      </div>
      <div class="center-contents margin-below">
        <select id="camList"></select>
      </div>

      <div class="center-contents margin-below">
        <button id="flashToggle">ðŸ“¸ Flash: <span id="flashState">off</span></button>
      </div>

      <div class="center-contents margin-below"><video id="video"></video></div>

      <div class="center-contents margin-below">
        <button id="backupButton">Print backup</button>
        <div id="qrText"></div>
      </div>
    </div>

    <div class="stage stage-backup">
      <div class="center-contents margin-below no-print">
        <button id="printButton">Print</button>
        <button id="goBackButton">Go back</button>
      </div>

      <div id="qrBackup" class="center-contents"></div>
    </div>

    <script src="./node_modules/qrcodejs/qrcode.js"></script>
    <script type="module">
      import QrScanner from './node_modules/qr-scanner/qr-scanner.min.js';
      QrScanner.WORKER_PATH = './node_modules/qr-scanner/qr-scanner-worker.min.js';

      let scanner = null;
      window.QrScanner = QrScanner;

      function setStage(name) {
        document.body.setAttribute('stage', name);
      }

      function setStatus(content) {
        statusMessage.textContent = content;
      }

      function delay(seconds) {
        return new Promise(resolve => setTimeout(resolve, seconds * 1000));
      }

      async function updateFlashOptions() {
        const hasFlash = await scanner.hasFlash();
        flashToggle.style.display = hasFlash ? '' : 'none';
      }

      function onScannerResult(result) {
        backupButton.style.display = 'inline-block';
        qrText.textContent = result;
      }

      flashToggle.addEventListener('click', async () => {
        await scanner.toggleFlash();
        flashState.textContent = scanner.isFlashOn() ? 'on' : 'off';
      });

      camList.addEventListener('change', async (event) => {
        await scanner.setCamera(event.target.value);
        await updateFlashAvailability();
      });

      const backupSize = Math.min(window.innerWidth, window.innerHeight);
      const backup = new QRCode(qrBackup, {
        text: '',
        width: backupSize,
        height: backupSize,
        colorDark : '#000000',
        colorLight : '#ffffff',
        correctLevel : QRCode.CorrectLevel.H,
      });

      backupButton.addEventListener('click', () => {
        scanner.stop();

        backup.makeCode(qrText.textContent);
        setStatus('Scan this to restore your backup');
        setStage('backup');

        window.print();
      });

      function readyToScan() {
        setStage('scan');
        setStatus('Point your camera at the QR you want to back up');
      }

      printButton.addEventListener('click', () => {
        window.print();
      });

      goBackButton.addEventListener('click', async () => {
        await scanner.start();
        readyToScan();
      });

      async function main() {
        setStatus('Detecting cameras...');
        const hasCamera = await QrScanner.hasCamera();
        if (!hasCamera) {
          setStatus('No camera found!');
          return;
        }

        setStatus('Camera found!');

        const cameras = await QrScanner.listCameras(true);
        for (const camera of cameras) {
          const option = document.createElement('option');
          option.value = camera.id;
          option.text = camera.label;
          camList.add(option);
        }

        scanner = window.scanner = new QrScanner(video,
            onScannerResult,
            error => {});

        scanner.setInversionMode('both');
        await scanner.start();
        await updateFlashOptions();

        await delay(1);
        readyToScan();
      }

      main();
    </script>
  </body>
</html>
